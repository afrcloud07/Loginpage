name: Total Reset and Multi Build

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  clean-and-build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Nuke and Process
        run: |
          # 1. SIMPAN DAFTAR ZIP KE MEMORI
          # Kita ambil daftar zip dulu sebelum folder dibersihkan
          ZIP_FILES=$(ls *.zip 2>/dev/null || true)

          if [ -z "$ZIP_FILES" ]; then
            echo "Tidak ada file ZIP ditemukan. Berhenti."
            exit 0
          fi

          # 2. HAPUS SEMUA FOLDER & FILE DI ROOT (Kecuali .github dan file .zip itu sendiri)
          echo "Membersihkan root repositori..."
          # Mencari semua file/folder selain .github, .git, dan *.zip lalu menghapusnya
          find . -maxdepth 1 ! -name '.github' ! -name '.git' ! -name '*.zip' ! -name '.' -exec rm -rf {} +

          # 3. PROSES SETIAP ZIP
          for zipfile in $ZIP_FILES; do
            foldername="${zipfile%.*}"
            echo "Memproses: $zipfile"

            # Ekstrak
            mkdir -p "$foldername"
            unzip -o "$zipfile" -d "$foldername"

            # Perbaiki struktur jika di dalam zip ada folder lagi
            INNER_DIR=$(find "$foldername" -name "package.json" -printf '%h' -quit)
            if [ -n "$INNER_DIR" ] && [ "$INNER_DIR" != "$foldername" ]; then
              mv "$INNER_DIR"/* "$foldername/" 2>/dev/null || true
            fi

            # Build
            cd "$foldername"
            rm -f .gitignore # Hapus agar folder dist bisa di-upload
            npm install
            npm run build:all || npm run build
            
            # Tambahkan info build agar folder terdeteksi 'baru'
            echo "Build: $(date)" > build-info.txt
            
            cd "$GITHUB_WORKSPACE"
          done

      - name: Commit and Force Push
        if: always()
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Tambahkan semua perubahan (termasuk penghapusan file lama)
          git add -A --force
          
          TIMESTAMP=$(date +'%Y-%m-%d %H:%M:%S')
          if ! git diff --cached --quiet; then
            git commit -m "Total Reset & Rebuild: $TIMESTAMP [skip ci]"
            git push origin main --force
          else
            # Tetap push commit kosong agar keterangan waktu di GitHub berubah ke "Just now"
            git commit --allow-empty -m "Manual Sync: $TIMESTAMP [skip ci]"
            git push origin main --force
          fi
