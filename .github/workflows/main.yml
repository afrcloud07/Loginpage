name: Multi ZIP Build with Auto-Cleanup

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-multi:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Process ZIPs and Cleanup
        run: |
          # 1. CLEANUP: Hapus folder yang ZIP-nya sudah tidak ada
          # Kita cek semua direktori di root kecuali folder sistem .git dan .github
          for dir in */; do
            dir=${dir%/} # Hapus slash di akhir nama folder
            if [[ "$dir" == ".github" || "$dir" == "node_modules" ]]; then continue; fi
            
            # Jika tidak ada file ZIP yang namanya sama dengan folder, hapus foldernya
            if [ ! -f "$dir.zip" ] && [ ! -f "$dir.ZIP" ]; then
              echo "Menghapus folder yatim (tanpa ZIP): $dir"
              git rm -rf "$dir" || rm -rf "$dir"
            fi
          done

          # 2. PROCESS: Ekstrak dan Build ZIP yang ada
          for zipfile in *.zip; do
            [ -e "$zipfile" ] || continue
            foldername="${zipfile%.*}"
            
            echo "Processing: $zipfile"
            
            # Hapus folder lama agar benar-benar fresh
            git rm -rf "$foldername" --ignore-unmatch 2>/dev/null || rm -rf "$foldername"
            mkdir -p "$foldername"
            
            unzip -o "$zipfile" -d "$foldername"
            
            # Cari letak package.json dan jalankan build
            INNER_DIR=$(find "$foldername" -name "package.json" -printf '%h' -quit)
            if [ -n "$INNER_DIR" ]; then
              if [ "$INNER_DIR" != "$foldername" ]; then
                mv "$INNER_DIR"/* "$foldername/" 2>/dev/null || true
              fi
              
              cd "$foldername"
              rm -f .gitignore
              npm install
              npm run build:all || npm run build
              cd "$GITHUB_WORKSPACE"
            fi
            
            # Tambahkan tanda timestamp agar folder terdeteksi "Baru saja" di GitHub
            echo "Last Build: $(date)" > "$foldername/build-info.txt"
          done

      - name: Commit and Force Push
        if: always()
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git add -A --force
          
          TS=$(date +'%Y-%m-%d %H:%M:%S')
          if ! git diff --cached --quiet; then
            git commit -m "Auto Update & Cleanup: $TS [skip ci]"
            git push origin main --force
          else
            echo "Tidak ada perubahan."
          fi
